# Visual Effect Graph 練習

## 事前設定

1. 要在 Unity 裝 HDRP + Visual Effect Graph + Shader Graph
2. 以及Edit>>Preferences >> Visual Effect >> Experimental Operators/Blocks 打勾 
    - 這是Visual Effect Graph實驗功能 在煙火案例會用到
    
![](_v_images/20201126230207222_423.png =476x)



## 基本練習

[教學來源](https://www.youtube.com/watch?v=LhvnIOlmXMM)

第一個練習就讓粒子，搖擺來熟悉基本操作

### 介面

![](_v_images/20201126230802869_17056.png =508x)
- 紅色區塊，就是變數區域
    - 負責變數整理，包含是否公開變數

- 藍色是擺放Block地方
    - 也就是將數據如何處理的地方

- 綠色就是粒子設定區塊    
    - 負責設定粒子該怎麼做，並且有執行順序，一律由上往下執行


### 粒子設定區塊


#### Spawn 產生區塊

粒子的第一步，只有一格，也就是設定每秒要噴發多少粒子

![](_v_images/20201127005019885_31653.png =531x)


#### Initialize Particle 初始化塊

也就是設定粒子，剛開始要如何

例如:生命週期、初始速度、初始位置.......之類

順便解說，在這例子中是將初始位置的X軸方向，連接上一正弦波方塊，讓輸出位置落在 (0~1) * Sine Max 範圍內

![](_v_images/20201127005338789_14712.png =803x)

#### Update 塊

Update塊，也就是讓每顆粒子在每一幀要做什麼

以下圖為例(這是其他例子)，粒子
- 每幀要受到重力影響
- 每幀確認粒子是否死亡
- 每幀都要執行事件


![](_v_images/20201127010654625_2663.png =623x)


#### Output 輸出區塊

其實輸出區塊，我覺得叫渲染區塊(Render)比較合適

因為它主要負責決定粒子跟攝影機問題，圖片問題、拉伸問題

也就是傳統粒子系統Render區塊差不多功能

![](_v_images/20201127013559365_28307.png =591x)


### Script溝通

有了粒子，但有時要在遊戲中更改粒子狀態，就能用C# Script來更改粒子數據

方法很簡單，只要拿到粒子系統，然後Set數據就行

#### **重點 Play 跟 Stop 不要放在Update裡這樣會變成一直呼叫粒子播放第一幀**

```csharp
//要using這個
using UnityEngine.VFX;

//這是粒子系統變數
public VisualEffect VFX;

//對VisualEffect傳輸數據，且數據名字要跟變數名一樣
VFX.SetVector3("Velocity", _Velocity);
```

```csharp
void Update()
    {
      //這樣OK
      if (Input.GetKeyDown(KeyCode.Space)){VFX.Play();}

      //這樣不行，會無法播放
      VFX.Play();
    }
```

### 粒子碰撞

[Visual Effect Graph快速上手指南](https://medium.com/akatsuki-taiwan-technology/unity-visual-effect-graph快速上手指南-a1906346ed30)

[粒子物理碰撞(5:32秒)](https://www.youtube.com/watch?v=w56xGS5P_X8)

這裡要解釋下，

目前Unity有兩套粒子系統

1.Particle System
2.Visual Effect Graph

Particle System也就是Unity傳統粒子系統，

傳統粒子由CPU執行所以跟"場景物件"進行"碰撞"的運算比較方便

而新版Visual Effect Graph粒子由GPU執行GPU不進行"碰撞運算"，雖然並非做不到，但耗效能，且當粒子達到百萬級時，效能會很低

#### 小結 : 需要物理"建議" 用 Particle System ，剩下的用Visual Effect Graph也可以

Visual Effect Graph碰撞很簡單，

就在Update裡放Collide(紅圈)，有不同形狀

Collide會在Scence裡出現碰撞範圍(綠箭頭地方)

而Collide有分成Local和World兩種，

Local是以粒子播放器為中心已Local座標計算碰撞範圍

World則是以世界座標來計算，所以要讓"物件"進行碰撞，就使用這種，透過腳本綁定傳送數據給粒子

![](_v_images/20201127221851652_28632.png =901x)

![](_v_images/20201127222055571_27389.png =423x)

### GPU 事件

[GPU事件](https://www.bilibili.com/video/BV14E411c76W/?spm_id_from=333.788.videocard.0)

這屬於實驗性功能，產生粒子事件，讓粒子能透過事件觸發下一個粒子

![](_v_images/20201127223929012_17945.png =684x)


## 煙火案例

[煙火](https://www.bilibili.com/video/BV14E411c76W/?spm_id_from=333.788.videocard.0)

好了基本練習差不多了，介紹煙火案例，原教學有上後處理組件(Post Processing)，但我沒用所以顏色不好看

主要有三個地方
1.發射的本體(藍色)
2.本體拖移的紅色尾巴(綠色 有點難看到)
3.爆炸後的煙火(紅色)

![](_v_images/20201128011954119_14111.png =799x)

### 邏輯脈絡

1. 本體生成在隨機位置(紅色)
2. 本體施加向上力道(紅色)
3. 本體移動時，用GPU事件要新增另一粒子來當拖尾(綠色)
4. 當本體生命週期結束，利用GPU事件新增煙花粒子(藍色)
5. 以及煙花的拖尾，但跟本體拖尾是不一樣的(黃色)

![](_v_images/20201128013326920_22071.png =504x)

## 粒子跟隨

[跟隨粒子教學(2:42秒)](https://www.youtube.com/watch?v=3EsITXwhlF4&list=PL-05SQhI5rIaX0Mlt0LHBc4QpJx5KtHhC&index=5)

這是一個粒子案例，我覺得粒子跟隨那段很不錯，所以截出來做測試

實際上原理蠻簡單的，也就是計算粒子當前位置跟目標位置間的向量，然後對粒子施加力道(影片2:42秒處有數學上公式)

也就是
1. 先計算標記物和粒子發射器向量方向(就是確定方向位置)
2. 將座標轉換為Local座標
3. 跟粒子Local計算向量位移
4. 單位化後乘上力度(吸引力)
5. 完成了

![](_v_images/20201128020639448_1382.png =800x)
![](_v_images/20201128020704767_254.png =800x)


## 黑洞

[黑洞](https://www.youtube.com/watch?v=FlE8e1JwVzs)

### 邏輯分析

1. 擾動區塊(黑線)，也就是會讓物體看起來有歪曲感(就是類似透過凸透鏡或凹透鏡看世界)
2. 中心球體邊緣發光(黃線)
3. 紫色漩渦(紅線)
4. 白點點往中心集中(藍線)

![](_v_images/20201129000324783_18048.png =800x)

### 擾動區塊

擾動區塊，原理是
讀取GPU緩存顏色，也就是讀取模型背後的背景顏色，
在加上噪點輸出，就形成擾動感覺

#### 注意

節點中

Scence Color意思是讀取緩衝區的顏色數據，就能讀取到物件後面顏色數據，能變成透明的

##### 但是 **"Scence Color"和"HD Scence Color"** 是不一樣的

Scence Color只能用在LWRP(URP)上並且必須在LWRP(URP)設定檔開啟Opaque Textures
![](_v_images/20201128185637890_17076.png =636x)
![](_v_images/20201128183659946_21242.png =380x)

HD Scence Color是只能應用在HDRP上面，並且Exposure要打勾
![](_v_images/20201128185718689_15235.png =688x)

### 中心

其實這沒什麼技術，用Fresnel就能實現

Fresnel也就是計算物體邊緣，然後輸出灰階圖，越邊緣越白，越中心越黑

然後疊個顏色

### 紫色漩渦

在教學案例是使用Particle System來執行

設定上就是做十字形狀，透過疊加旋轉實現

### 白粒子

使用VFX，重點就是在Update裡，實現粒子位置計算來確定位置，並向中間靠攏

## 黑洞小結

整體來說較難的是，擾動那邊，那邊需要些渲染知識，若是還有點不懂參考

雖然使用Shader Forge來製作，但原理基本一致

[折射](https://www.bilibili.com/video/BV1Gx411h71Q)

[扭曲](https://www.bilibili.com/video/BV1kx411a7gB)



# 總結

Visual Effect Graph是一個**好用、強大**的粒子系統，但並非沒缺點

1. ~~Visual Effect Graph只能應用在HDRP上，所以部分手機是無法支援使用~~ 以確認URP(LWRP)可以使用VFX但要重新編譯一次
2. 跟Shader Graph 一樣上手簡單，做好卻很難
3. 以及要注意，不要玩得太開心就用個百萬級粒子，電腦會當掉.....(親身經歷)

大致上會使用Particle System下，學習Visual Effect Graph並不難，

因為主要還是那幾個數據名字，只是在於Visual Effect Graph多了Update來加強能力。

